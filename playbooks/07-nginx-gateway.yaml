---
# Playbook: Deploy NGINX Gateway Fabric (Kubernetes Gateway API)
# Provides Gateway API implementation using NGINX

- name: Deploy NGINX Gateway Fabric
  hosts: rpi-1
  become: true
  vars_files:
    - ../group_vars/all.yaml
  vars:
    nginx_gateway_version: "1.4.0"
  tasks:
    - name: Create nginx-gateway manifests directory
      file:
        path: /root/manifests/nginx-gateway
        state: directory
        mode: '0755'

    - name: Install Gateway API CRDs
      command: kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.1.0/standard-install.yaml
      register: crds_result
      changed_when: "'created' in crds_result.stdout or 'configured' in crds_result.stdout"

    - name: Download NGINX Gateway Fabric manifests
      get_url:
        url: "https://github.com/nginxinc/nginx-gateway-fabric/releases/download/v{{ nginx_gateway_version }}/crds.yaml"
        dest: /root/manifests/nginx-gateway/crds.yaml
        mode: '0644'

    - name: Download NGINX Gateway Fabric deployment
      get_url:
        url: "https://github.com/nginxinc/nginx-gateway-fabric/releases/download/v{{ nginx_gateway_version }}/nginx-gateway.yaml"
        dest: /root/manifests/nginx-gateway/nginx-gateway.yaml
        mode: '0644'

    - name: Apply NGINX Gateway Fabric CRDs
      command: kubectl apply -f /root/manifests/nginx-gateway/crds.yaml
      register: ngf_crds_result
      changed_when: "'created' in ngf_crds_result.stdout"

    - name: Apply NGINX Gateway Fabric deployment
      command: kubectl apply -f /root/manifests/nginx-gateway/nginx-gateway.yaml
      register: ngf_result
      changed_when: "'created' in ngf_result.stdout"

    - name: Wait for NGINX Gateway Fabric to be ready
      command: >
        kubectl wait --for=condition=available deployment/nginx-gateway
        -n nginx-gateway --timeout=300s
      changed_when: false
      ignore_errors: true

    - name: Patch NGINX Gateway service to NodePort
      command: >
        kubectl patch svc nginx-gateway -n nginx-gateway
        -p '{"spec": {"type": "NodePort", "ports": [{"port": 80, "targetPort": 80, "nodePort": 30080, "name": "http"}, {"port": 443, "targetPort": 443, "nodePort": 30443, "name": "https"}]}}'
      register: patch_result
      changed_when: "'patched' in patch_result.stdout"
      ignore_errors: true

    - name: Create default GatewayClass
      command: |
        kubectl apply -f - <<EOF
        apiVersion: gateway.networking.k8s.io/v1
        kind: GatewayClass
        metadata:
          name: nginx
        spec:
          controllerName: gateway.nginx.org/nginx-gateway-controller
        EOF
      register: gc_result
      changed_when: "'created' in gc_result.stdout"

    - name: Create default Gateway
      command: |
        kubectl apply -f - <<EOF
        apiVersion: gateway.networking.k8s.io/v1
        kind: Gateway
        metadata:
          name: main-gateway
          namespace: default
        spec:
          gatewayClassName: nginx
          listeners:
            - name: http
              protocol: HTTP
              port: 80
              allowedRoutes:
                namespaces:
                  from: All
        EOF
      register: gw_result
      changed_when: "'created' in gw_result.stdout"

    - name: Display NGINX Gateway info
      debug:
        msg: |
          NGINX Gateway Fabric is installed!
          HTTP: http://{{ registry_host }}:30080
          HTTPS: https://{{ registry_host }}:30443

          Create HTTPRoutes to expose services:

          apiVersion: gateway.networking.k8s.io/v1
          kind: HTTPRoute
          metadata:
            name: my-app-route
          spec:
            parentRefs:
              - name: main-gateway
                namespace: default
            hostnames:
              - "myapp.local"
            rules:
              - matches:
                  - path:
                      type: PathPrefix
                      value: /
                backendRefs:
                  - name: my-service
                    port: 80
